<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>
<body>
  <div class="container">
    <h5>Inserir Nova Fatura</h5>
    
    <form id="formularioFatura">
      <div class="row form-row">
        <div class="input-field col s6">
          <input type="date" id="dataEntrada" name="dataEntrada" required>
          <label for="dataEntrada" class="active">Data Entrada</label>
        </div>
        <div class="input-field col s6">
          <input type="text" id="protocolo" name="protocolo" required>
          <label for="protocolo">Protocolo (apenas números)</label>
          <small class="helper-text">Formato: XX.XXX.XXX-X</small>
        </div>
      </div>
      
      <div class="row form-row">
        <div class="input-field col s6">
          <input type="number" id="fatura" name="fatura" required>
          <label for="fatura">Fatura</label>
        </div>
        <div class="input-field col s6">
          <input type="text" id="contrato" name="contrato" required placeholder="Ex: 7023/2022">
          <label for="contrato">Contrato (apenas número/ano)</label>
          <small class="helper-text">Será formatado como: CA XXXX/202X - GMS</small>
        </div>
      </div>
      
      <div class="row form-row">
        <div class="input-field col s12">
          <input type="text" id="obra" name="obra" required readonly>
          <label for="obra" class="active">Obra (preenchido automaticamente)</label>
        </div>
      </div>
      
      <!-- Nova seção para empenhos relacionados ao contrato -->
      <div id="empenhos-relacionados" class="row form-row empenhos-section hide">
        <div class="col s12">
          <div class="empenhos-header">
            <h6 class="empenhos-title">Empenhos disponíveis para este contrato:</h6>
            <div id="empenhos-counter" class="chip">0 empenhos</div>
          </div>
          
          <div id="empenhos-loading" class="preloader-container">
            <div class="preloader-wrapper small active">
              <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                  <div class="circle"></div>
                </div>
                <div class="gap-patch">
                  <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                  <div class="circle"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div id="empenhos-container" class="empenhos-container">
            <!-- Os empenhos serão adicionados aqui dinamicamente -->
          </div>
        </div>
      </div>
      
      <div class="row form-row">
        <div class="input-field col s4">
          <input type="text" id="medicao" name="medicao" required>
          <label for="medicao">Medição</label>
        </div>
        <div class="input-field col s4">
          <input type="text" id="valor" name="valor" required>
          <label for="valor">Valor (R$)</label>
        </div>
        <div class="input-field col s4">
          <input type="text" id="empenho" name="empenho" required>
          <label for="empenho">Empenho</label>
          <small class="helper-text">Selecione acima ou digite o número</small>
        </div>
      </div>
      
      <div class="row form-row">
        <div class="input-field col s6">
          <select id="tipo" name="tipo" required>
            <option value="" disabled selected>Selecione</option>
            <!-- Opções serão carregadas via JavaScript -->
          </select>
          <label for="tipo">Tipo</label>
        </div>
        <div class="input-field col s6">
          <select id="acaoOrcamentaria" name="acaoOrcamentaria" required>
            <option value="" disabled selected>Selecione</option>
            <!-- Opções serão carregadas via JavaScript -->
          </select>
          <label for="acaoOrcamentaria">Ação Orçamentária</label>
        </div>
      </div>
      
      <div class="row form-row">
        <div class="input-field col s6">
          <select id="fonte" name="fonte" required>
            <option value="" disabled selected>Selecione</option>
            <!-- Opções serão carregadas via JavaScript -->
          </select>
          <label for="fonte">Fonte</label>
        </div>
        <div class="input-field col s6">
          <select id="elementoDespesa" name="elementoDespesa" required>
            <option value="" disabled selected>Selecione</option>
            <!-- Opções serão carregadas via JavaScript -->
          </select>
          <label for="elementoDespesa">Elemento de Despesa</label>
        </div>
      </div>
      
      <div id="fixed-actions" class="fixed-buttons">
        <button type="button" id="btnCancelar" class="btn btn-cancelar waves-effect waves-light">
          <i class="material-icons left">cancel</i>Cancelar
        </button>
        <button type="submit" class="btn btn-inserir waves-effect waves-light">
          <i class="material-icons left">add</i>Inserir Fatura
        </button>
      </div>
    </form>
    
    <div id="statusMensagem" class="status-message hide"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Variável para rastrear se um contrato foi alterado
      let contratoAnterior = '';
      
      // Inicializa componentes do Materialize
      M.AutoInit();
      
      // Carrega valores existentes para os dropdowns
      google.script.run
        .withSuccessHandler(preencherDropdowns)
        .obterValoresExistentes();
      
      // Formata o campo de protocolo enquanto o usuário digita
      document.getElementById('protocolo').addEventListener('input', function(e) {
        // Remove qualquer caractere não numérico
        let value = e.target.value.replace(/\D/g, '');
        
        // Limita a 9 dígitos
        if (value.length > 9) {
          value = value.substring(0, 9);
        }
        
        // Aplica a formatação XX.XXX.XXX-X à medida que o usuário digita
        let formattedValue = '';
        
        if (value.length > 0) {
          // Adiciona os primeiros dois dígitos
          formattedValue = value.substring(0, Math.min(2, value.length));
          
          // Adiciona o primeiro ponto se tiver pelo menos 3 dígitos
          if (value.length > 2) {
            formattedValue += '.' + value.substring(2, Math.min(5, value.length));
            
            // Adiciona o segundo ponto se tiver pelo menos 6 dígitos
            if (value.length > 5) {
              formattedValue += '.' + value.substring(5, Math.min(8, value.length));
              
              // Adiciona o hífen se tiver 9 dígitos
              if (value.length > 8) {
                formattedValue += '-' + value.substring(8, 9);
              }
            }
          }
        }
        
        e.target.value = formattedValue;
      });
      
      // Formata o campo de contrato enquanto o usuário digita
      document.getElementById('contrato').addEventListener('input', function(e) {
        // Remove qualquer texto padrão como "CA" ou "GMS" caso o usuário tente digitá-los
        let value = e.target.value.replace(/CA |ca |Ca | - GMS|-GMS|GMS/g, '').trim();
        
        // Remove espaços extras e caracteres que não sejam números, barras ou hífens
        value = value.replace(/[^\d\/\-]/g, '');
        
        // Se o usuário já digitou algum valor, mantenha no formato original
        e.target.value = value;
      });
      
      // Formata o contrato completo ao sair do campo
      document.getElementById('contrato').addEventListener('blur', function(e) {
        let value = e.target.value.trim();
        
        // Verifica se há conteúdo para formatar
        if (value) {
          let contratoFormatado = 'CA ' + value + ' - GMS';
          
          // Verifica se o contrato realmente mudou antes de buscar
          if (contratoFormatado !== contratoAnterior) {
            contratoAnterior = contratoFormatado;
            e.target.value = contratoFormatado;
            
            // Busca a obra automaticamente com o contrato formatado
            buscarObraPeloContrato(contratoFormatado);
          } else {
            e.target.value = contratoFormatado;
          }
        }
      });
      
      // Função para buscar obra pelo contrato
      function buscarObraPeloContrato(contrato) {
        if (contrato) {
          document.getElementById('obra').value = "Buscando...";
          
          // Mostra a seção de empenhos com o loading
          const empenhosSection = document.getElementById('empenhos-relacionados');
          empenhosSection.classList.remove('hide');
          document.getElementById('empenhos-loading').style.display = 'flex';
          document.getElementById('empenhos-container').innerHTML = '';
          
          // Limpa o campo de empenho quando o contrato muda
          document.getElementById('empenho').value = '';
          
          // Como o contrato mudou, limpa os dados relacionados
          // Esta é uma ação apropriada quando o contrato muda
          resetarCamposAutoPreenchidos();
          
          // Busca a obra
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.sucesso) {
                document.getElementById('obra').value = result.obra;
                
                // Agora busca os empenhos relacionados ao contrato
                buscarEmpenhosPorContrato(contrato);
              } else {
                document.getElementById('obra').value = "";
                M.toast({html: result.mensagem, classes: 'red'});
                
                // Esconde a seção de empenhos
                document.getElementById('empenhos-relacionados').classList.add('hide');
              }
            })
            .withFailureHandler(function(error) {
              document.getElementById('obra').value = "";
              M.toast({html: "Erro ao buscar obra: " + error, classes: 'red'});
              
              // Esconde a seção de empenhos
              document.getElementById('empenhos-relacionados').classList.add('hide');
            })
            .buscarObraPorContrato(contrato);
        }
      }
      
      // Função para buscar empenhos por contrato
      function buscarEmpenhosPorContrato(contrato) {
        google.script.run
          .withSuccessHandler(exibirEmpenhos)
          .withFailureHandler(function(erro) {
            document.getElementById('empenhos-loading').style.display = 'none';
            document.getElementById('empenhos-relacionados').classList.add('hide');
            M.toast({html: "Erro ao buscar empenhos: " + erro, classes: 'red'});
          })
          .buscarEmpenhosPorContrato(contrato);
      }
      
      // Função para exibir os empenhos
      function exibirEmpenhos(resultado) {
        var container = document.getElementById('empenhos-container');
        document.getElementById('empenhos-loading').style.display = 'none';
        
        // Limpa a lista atual
        container.innerHTML = '';
        
        if (resultado.sucesso && resultado.empenhos && resultado.empenhos.length > 0) {
          // Atualiza o contador de empenhos
          document.getElementById('empenhos-counter').textContent = 
            resultado.empenhos.length + ' empenho(s)';
          
          // Adiciona cada empenho como um card
          resultado.empenhos.forEach(function(empenho) {
            // Formata o saldo como moeda
            var saldo = parseFloat(empenho.saldo);
            var saldoFormatado = 'R$ ' + saldo.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            
            // Cria o card do empenho
            var card = document.createElement('div');
            card.className = 'card empenho-card';
            card.innerHTML = `
              <div class="card-content">
                <span class="empenho-numero">${empenho.numero}</span>
                <span class="empenho-saldo">${saldoFormatado}</span>
              </div>
            `;
            
            // Adiciona evento de clique para selecionar o empenho
            card.addEventListener('click', function() {
              selecionarEmpenho(empenho.numero);
              
              // Efeito visual de seleção
              var cards = document.querySelectorAll('.empenho-card');
              cards.forEach(function(c) {
                c.style.backgroundColor = '';
              });
              this.style.backgroundColor = '#e3f2fd';
            });
            
            container.appendChild(card);
          });
          
          // Mostra a seção de empenhos
          document.getElementById('empenhos-relacionados').classList.remove('hide');
        } else {
          // Se não encontrou empenhos
          if (resultado.sucesso) {
            container.innerHTML = `
              <div class="center-align" style="padding: 20px; color: #9e9e9e;">
                <i class="material-icons medium">search</i>
                <p>Nenhum empenho encontrado para este contrato.</p>
              </div>
            `;
            document.getElementById('empenhos-counter').textContent = '0 empenhos';
            document.getElementById('empenhos-relacionados').classList.remove('hide');
          } else {
            M.toast({html: resultado.mensagem, classes: 'red'});
            document.getElementById('empenhos-relacionados').classList.add('hide');
          }
        }
      }
      
      // Função simplificada para apenas selecionar o empenho, sem buscar histórico
      function selecionarEmpenho(numeroEmpenho) {
        // Preenche o campo de empenho
        document.getElementById('empenho').value = numeroEmpenho;
        document.getElementById('empenho').focus();
        M.updateTextFields(); // Atualiza os labels do Materialize
        
        // Destaca o empenho selecionado visualmente
        M.toast({html: 'Empenho selecionado: ' + numeroEmpenho, classes: 'blue'});
      }
      
      // Função simplificada para apenas resetar os campos de seleção
      function resetarCamposAutoPreenchidos() {
        // Reseta os valores dos selects
        document.getElementById('acaoOrcamentaria').value = '';
        document.getElementById('fonte').value = '';
        document.getElementById('elementoDespesa').value = '';
        
        // Reinicializa os selects do Materialize
        M.FormSelect.init(document.getElementById('acaoOrcamentaria'));
        M.FormSelect.init(document.getElementById('fonte'));
        M.FormSelect.init(document.getElementById('elementoDespesa'));
      }
      
      // Removida a funcionalidade de busca de histórico ao perder o foco do campo empenho
      document.getElementById('empenho').addEventListener('blur', function() {
        // Apenas atualiza o campo visualmente, sem buscar histórico
        M.updateTextFields();
      });
      
      // Formata o campo de valor para moeda
      document.getElementById('valor').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = (parseFloat(value) / 100).toFixed(2);
        e.target.value = value;
      });
      
      // Esta função não é mais necessária pois não preenchemos campos automaticamente
      
      // Manipulador de envio do formulário
      document.getElementById('formularioFatura').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Valida o protocolo antes de enviar - apenas verificando se tem conteúdo
        const protocolo = document.getElementById('protocolo').value;
        if (!protocolo.trim()) {
          M.toast({html: 'Por favor, preencha o protocolo.', classes: 'red'});
          return;
        }
        
        // Valida o formato do contrato
        const contrato = document.getElementById('contrato').value.trim();
        if (!contrato.match(/^CA \d+\/\d+ - GMS$/)) {
          // Se o usuário digitou algo, mas não está no formato completo, formata-o automaticamente
          if (contrato) {
            const contratoLimpo = contrato.replace(/CA |ca |Ca | - GMS|-GMS|GMS/g, '').trim();
            document.getElementById('contrato').value = 'CA ' + contratoLimpo + ' - GMS';
          } else {
            M.toast({html: 'Por favor, preencha o contrato.', classes: 'red'});
            return;
          }
        }
        
        const form = this;
        const formData = {
          dataEntrada: form.dataEntrada.value,
          protocolo: form.protocolo.value,
          fatura: form.fatura.value,
          contrato: form.contrato.value,
          obra: form.obra.value,
          medicao: form.medicao.value,
          valor: form.valor.value,
          empenho: form.empenho.value,
          tipo: form.tipo.value,
          acaoOrcamentaria: form.acaoOrcamentaria.value,
          fonte: form.fonte.value,
          elementoDespesa: form.elementoDespesa.value
        };
        
        // Desabilita os botões durante o envio
        document.querySelector('.btn-inserir').disabled = true;
        document.querySelector('#btnCancelar').disabled = true;
        
        // Mostra indicador de carregamento
        M.toast({html: 'Inserindo fatura...', classes: 'blue'});
        
        // Envia os dados para o Google Apps Script
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleError)
          .inserirDadosNaPlanilha(formData);
      });
      
      // Manipulador do botão Cancelar
      document.getElementById('btnCancelar').addEventListener('click', function() {
        google.script.host.close();
      });
    });
    
    // Preenche os dropdowns com valores existentes
    function preencherDropdowns(valores) {
      const tipoSelect = document.getElementById('tipo');
      const acaoSelect = document.getElementById('acaoOrcamentaria');
      const fonteSelect = document.getElementById('fonte');
      const elementoSelect = document.getElementById('elementoDespesa');
      
      // Preenche o dropdown de Tipos
      valores.tipos.forEach(function(tipo) {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tipo;
        tipoSelect.appendChild(option);
      });
      
      // Preenche o dropdown de Ações Orçamentárias
      valores.acoes.forEach(function(acao) {
        const option = document.createElement('option');
        option.value = acao;
        option.textContent = acao;
        acaoSelect.appendChild(option);
      });
      
      // Preenche o dropdown de Fontes
      valores.fontes.forEach(function(fonte) {
        const option = document.createElement('option');
        option.value = fonte;
        option.textContent = fonte;
        
        // Adiciona classes de cor conforme a imagem
        switch(fonte) {
          case "125":
            option.style.backgroundColor = "#ffcdd2";
            break;
          case "107":
            option.style.backgroundColor = "#ffe082";
            break;
          case "258":
            option.style.backgroundColor = "#fff59d";
            break;
          case "285":
            option.style.backgroundColor = "#c8e6c9";
            break;
          case "113":
            option.style.backgroundColor = "#bbdefb";
            break;
          case "500":
            option.style.backgroundColor = "#e1bee7";
            break;
          case "751":
            option.style.backgroundColor = "#d1c4e9";
            break;
        }
        
        fonteSelect.appendChild(option);
      });
      
      // Preenche o dropdown de Elementos de Despesa
      valores.elementosDespesa.forEach(function(elemento) {
        const option = document.createElement('option');
        option.value = elemento;
        option.textContent = elemento;
        
        // Adiciona classes de cor conforme a imagem
        switch(elemento) {
          case "3390.39":
            option.style.backgroundColor = "#ffcdd2";
            break;
          case "4390.39":
            option.style.backgroundColor = "#ffe082";
            break;
          case "4440.42":
            option.style.backgroundColor = "#c8e6c9";
            break;
          case "4490.92":
            option.style.backgroundColor = "#bbdefb";
            break;
        }
        
        elementoSelect.appendChild(option);
      });
      
      // Reinicializa os componentes do Materialize para atualizar a UI
      M.FormSelect.init(tipoSelect);
      M.FormSelect.init(acaoSelect);
      M.FormSelect.init(fonteSelect);
      M.FormSelect.init(elementoSelect);
    }
    
    // Manipulador de sucesso
    function handleSuccess(response) {
      const statusMsg = document.getElementById('statusMensagem');
      
      if (response.sucesso) {
        statusMsg.textContent = response.mensagem;
        statusMsg.className = 'status-message success';
        
        // Desabilita os botões para evitar cliques múltiplos
        document.querySelector('.btn-inserir').disabled = true;
        document.querySelector('#btnCancelar').disabled = true;
        
        // Limpa o formulário após 2 segundos e fecha o dialog
        setTimeout(function() {
          document.getElementById('formularioFatura').reset();
          google.script.host.close();
        }, 2000);
      } else {
        handleError(response.mensagem);
      }
      
      statusMsg.classList.remove('hide');
    }
    
    // Manipulador de erro
    function handleError(error) {
      const statusMsg = document.getElementById('statusMensagem');
      statusMsg.textContent = typeof error === 'string' ? error : 'Ocorreu um erro ao processar sua solicitação.';
      statusMsg.className = 'status-message error';
      statusMsg.classList.remove('hide');
      document.querySelector('.btn-inserir').disabled = false;
      document.querySelector('#btnCancelar').disabled = false;
    }
  </script>
</body>
</html>